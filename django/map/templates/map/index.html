{% extends "base.html" %} {% load render_bundle from webpack_loader %} {% load bootstrap4 %} {% block title %}Index{% endblock %} {% block main %} {% load static %} {% load leaflet_tags %}

<!doctype html>
<html>
{% load static %} {% load leaflet_tags %}
<!-- Ingird: vad gör denna? Behövs ev ej -->

<head>
    {{ form.media }}
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <!--<script type="text/javescript" src='% static dist/leaflet.ajax.js'></script>-->
    <script type="text/javascript" src="http://code.jquery.com/jquery-3.1.0.min.js"></script>

    <style>
        /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */

        #map {
            height: 100%;
        }

        /* Optional: Makes the sample page fill the window. */

        html,
        body {
            height: 80%;
            margin: 0;
            padding: 0;
        }

        #infowindow-content {
            display: none;
        }

        #map #infowindow-content {
            display: inline;
        }

        #info-box {
            height: 20px;
            /*Ingrid: change to something better*/
            background-color: yellow;
            /*Ingrid: change to something better*/
        }

    </style>

</head>

<body>
    <!-- Here is the main menu added to the page -->
    {% if user.is_authenticated %}
    <div id="MenuAppAuth"></div>
    {% render_bundle 'vendors' %} {% render_bundle 'MenuAppAuth' %}

    <h3> Detta är Toolgate Maps flik för kartan. Detta är en googlekarta. </h3>
    <input id="citySearch" class="controls" type="text" placeholder="Search Box">
    <br>
    <h4>Text</h4>
    <div id="map"></div>
    <div class="col-sm-6" style="background-color: white">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="card-title">Fastighetsinformation</h3><br>
                <p>
                    <li></li><br>
                    <li>Data över hela Sverige</li><br>
                    <li>bla bla bla</li><br>
                </p>
            </div>
        </div>
    </div>
    <div id="info-box">
        <h4>Här visas ägaren sen när du tryckt. </h4>
    </div>
    {% else %}

    <div id="MenuApp"></div>
    {% render_bundle 'vendors' %} {% render_bundle 'MenuApp' %}
    <p>You are not logged in</p>
    <p>Please login to see this page.</p>
    {% endif %}

    <script>
        var map;
        var previousClickedMarker;
        var blueIcon = 'https://maps.google.com/mapfiles/kml/shapes/library_maps.png';
        var redIcon = 'https://www.google.com/mapfiles/marker_green.png';
        var ownerObj;

        function initMapAndLayers() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 5,
                center: {
                    lat: 59,
                    lng: 17
                }
            });
            previousClickedMarker = new google.maps.Marker({
                position: new google.maps.LatLng(1, 1),
                map: map,
                showInfo: false,
            })


            // ************* START TEST MAKING MAEKERS FRON JSON *********************
            var propertyGEOJSON = [{
                "type": "FeatureCollection",
                "crs": {
                    "type": "name",
                    "properties": {
                        "name": "EPSG:4326"
                    }
                },
                "features": [{
                    "type": "Feature",
                    "properties": {
                        "area": "64.000000000000",
                        "coord_e": "10.000",
                        "coord_n": "25.000",
                        "owners": [2],
                        "pk": "2"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [21.659586671232507, 64.61598263673106]
                    }
                }, {
                    "type": "Feature",
                    "properties": {
                        "area": "24.000000000000",
                        "coord_e": "32.000",
                        "coord_n": "34.000",
                        "owners": [1],
                        "pk": "1"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [14.476761436347962, 54.78120947893149]
                    }
                }, {
                    "type": "Feature",
                    "properties": {
                        "area": "60.000000000000",
                        "coord_e": "45.000",
                        "coord_n": "43.000",
                        "owners": [3],
                        "pk": "3"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [18.36512247158684, 60.67960017270254]
                    }
                }, {
                    "type": "Feature",
                    "properties": {
                        "area": "199.000000000000",
                        "coord_e": "87.000",
                        "coord_n": "85.000",
                        "owners": [3],
                        "pk": "4"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [17.078571410844813, 57.372694253045616]
                    }
                }]
            }]

            for (var i = 0, length = propertyGEOJSON[0].features.length; i < length; i++) {
                createMarkerWithListener(i);
                /*lat = propertyGEOJSON[0].features[i].geometry.coordinates[0];
                lng = propertyGEOJSON[0].features[i].geometry.coordinates[1];
                ownerID = propertyGEOJSON[0].features[i].properties.owners;

                var data = propertyGEOJSON[i],
                    latLng = new google.maps.LatLng(lng, lat);

                // Creating a marker and putting it on the map
                var propertyMarker = new google.maps.Marker({
                    position: latLng,
                    map: map,
                    icon: redIcon,
                    ownerID: ownerID
                });
                console.log(latLng.toString());

                //                propertyMarker.addListener('click', clickedProperty);
                propertyMarker.addListener('click', function() {
                    console.log("this ovanför");
                    console.log(propertyMarker);
                    console.log("ovanför är infon jag vill se");
                    clickedProperty(propertyMarker);
                })*/
            }

            function createMarkerWithListener(i) {
                lat = propertyGEOJSON[0].features[i].geometry.coordinates[0];
                lng = propertyGEOJSON[0].features[i].geometry.coordinates[1];
                ownerID = propertyGEOJSON[0].features[i].properties.owners;

                var data = propertyGEOJSON[i],
                    latLng = new google.maps.LatLng(lng, lat);

                // Creating a marker and putting it on the map
                var propertyMarker = new google.maps.Marker({
                    position: latLng,
                    map: map,
                    icon: redIcon,
                    ownerID: ownerID,
                    showInfo: false,
                    id: i
                });
                console.log(latLng.toString());

                propertyMarker.addListener('click', function() {
                    //                    console.log(propertyMarker);
                    //                    console.log("ovanför är infon jag vill se");
                    clickedProperty(propertyMarker);
                })
            }

            function clickedProperty(propertyMarker) {
                changeMarker(propertyMarker);
                //                console.log(propertyMarker);
                //                console.log("propertymarker här ovan");
                console.log("klickat ownerID: " + propertyMarker.ownerID);
                findAndPrintOwners(ownerObj, propertyMarker.ownerID);
            }



            //************************** END TEST MAKING MARKERS FROM JSON ************************

            //********************* THIS IS EXPERIMENTAL PLACE FOR CHANGING MARKER COLOR ******************

            testMarker = new google.maps.Marker({
                map: map,
                draggable: true,
                icon: redIcon,
                animation: google.maps.Animation.DROP,
                position: {
                    lat: 59.327,
                    lng: 23.067
                },
                showInfo: false,
            });
            testMarker.addListener('click', toggleBounce);

            function toggleBounce() {
                if (testMarker.showInfo == false) {
                    testMarker.setIcon(redIcon);
                    console.log("showInfo är " + testMarker.showInfo);
                    testMarker.showInfo = true;
                } else {
                    testMarker.setIcon(blueIcon);
                    console.log("showInfo är " + testMarker.showInfo);
                    testMarker.showInfo = false;
                }
            }
            //********************* END CHANGING MARKER COLOR ******************

            // NOTE: This uses cross-domain XHR, and may not work on older browsers, comment from google.

            // map.data.loadGeoJson('http://localhost:8000/toolgate_maps/propertyBorders_data/');
            map.data.loadGeoJson('https://storage.googleapis.com/mapsdevsite/json/google.json');
            // map.data.loadGeoJson('http://localhost:8000/toolgate_maps/properties_data/');

            map.data.setStyle(function(feature) { // Styling of boarderlines. Ingrid
                return {
                    strokeWeight: 0.5,
                    strokeColor: "#0000ff",
                    clickable: true,
                    icon: feature.getProperty(blueIcon),
                }
            });

            createSearchBoxCities(map);
        }

        const ownersURL = "http://localhost:8000/toolgate_maps/propertyOwners_data/";
        $.ajax({
            url: ownersURL,
            success: function(result) {
                ownerObj = result; //The ownerJson as an object. IM

                //                    console.log(ownerObj);
                //                    console.log("specifik feature: " + ownerObj.features[1]);
                //                    console.log(": " + ownerObj.features[1].properties["pk"]);

                /*    map.data.addListener('click', function(event) {
                        var ownerID = event.feature.getProperty('owners'); //IM: this is the owners id to the clicked property
                        console.log("klickat ownerID: " + ownerID);
                        findAndPrintOwners(ownerObj, ownerID);
                        changeMarker(event);

                    });*/
            }

        });

        //************* FUNCTIONS UNDER HERE *****************

        function createSearchBoxCities(map) {
            var input = document.getElementById('citySearch');
            var searchBox = new google.maps.places.SearchBox(input);
            //            map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

            // Bias the SearchBox results towards current map's viewport.
            map.addListener('bounds_changed', function() {
                searchBox.setBounds(map.getBounds());
            });

            var markers = [];
            // Listen for the event fired when the user selects a prediction and retrieve
            // more details for that place.
            searchBox.addListener('places_changed', function() {
                var places = searchBox.getPlaces();

                if (places.length == 0) {
                    return;
                }

                // Clear out the old markers.
                markers.forEach(function(marker) {
                    marker.setMap(null);
                });
                markers = [];

                // For each place, get the icon, name and location.
                var bounds = new google.maps.LatLngBounds();
                places.forEach(function(place) {
                    if (!place.geometry) {
                        console.log("Returned place contains no geometry");
                        return;
                    }

                    if (place.geometry.viewport) {
                        // Only geocodes have viewport.
                        bounds.union(place.geometry.viewport);
                    } else {
                        bounds.extend(place.geometry.location);
                    }
                });
                map.fitBounds(bounds);
            });
        }

        function findAndPrintOwners(ownerObj, ownerID) {
            var i;
            for (i = 0; i < ownerObj.features.length; i++) {
                if (ownerObj.features[i].properties["pk"] == ownerID) { //IM: loops through the owners to find a match. 
                    console.log("Det finns en träff med ägare och property");
                    firstName = ownerObj.features[i].properties["firstname"];
                    surName = ownerObj.features[i].properties["surname"];
                    companyName = ownerObj.features[i].properties["coname"];
                    juridicalForm = ownerObj.features[i].properties["jurform"];
                    reg_no = ownerObj.features[i].properties["reg_no"];

                    document.getElementById('info-box').innerHTML = "<h4> Förnamn " + firstName + "<br/>" + "<h3> Efternamn " + surName + " " + companyName + "<br> " + juridicalForm + " " + reg_no;

                }
            }
        }

        function changeMarker(theMarker) {
            console.log("ska byta marker");
            console.log(theMarker.showInfo);

            if (theMarker.showInfo == true) {
                console.log("IF showInfo är " + theMarker.showInfo);
                unclickMarker(theMarker);
            } else {
                theMarker.setIcon(blueIcon);
                console.log("ELSE showInfo är " + theMarker.showInfo);
                theMarker.showInfo = true;
                if (previousClickedMarker.id!=theMarker.id){
                    unclickMarker(previousClickedMarker);
                }
                
                
                previousClickedMarker = theMarker;
            }

        }

        function unclickMarker(theMarker) {
            console.log("showInfo: " + theMarker.showInfo);
            theMarker.setIcon(redIcon);
            theMarker.showInfo = false;
            console.log("återställer markern");
        }

    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTGG7XrK5kRzyrpBKEH3ZwQ3wNprTmgDI&libraries=places&callback=initMapAndLayers"></script>
    <!--{ % block javascript %}-->
</body>

</html>
{% endblock %}
